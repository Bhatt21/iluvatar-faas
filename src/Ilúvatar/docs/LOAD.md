# Load Generation

## Commands

All commands share some common paramaters.
These must be passed *before* the command value.

1. `--port`, or `-p` is the port the target is listening on.
1. `--host`, or `-h` is the host name or IP address the target is listening on.
1. `--out`, or `-o` specifies the output folder to store results in.
1. `--help` prints help information of shared information.

```sh
ilúvatar_load_gen -p 8079 -h localhost trace 
ilúvatar_load_gen --help
```

`--help` can also be specified for each command, with detailed help for it.
```sh
ilúvatar_load_gen trace --help
```

### Scaling load

// TODO: this

### Trace load

This allows a series of predetermined function invocations to be run on either a worker or controller.
Two csv files control what functions are run at what time, to the millisecond.

```sh
ilúvatar_load_gen -p 100 -h localhost trace 
```

1. `--target`, `-t`: What is the experiment targeting? 
Specifying `worker` and it will use RPCs to communicate with a single worker directly.
This will also generate transaction IDs internally as well. 
Or `controller` will then use HTTP requests to communcate with a controller.
The target will affect the results file, i.e. we can't have controller latency information if we are targeting a worker.

1. `--setup`: Is the experiment is a simulation of Ilúvatar or a live system? 
Passing `simulation` has the load generator create a simulated version of the target and running load on that system.
The simulation *does not* run real function code, and invocations *do not* take up CPU or memory resources.
Passing `live` means the system has been set up elsewhere and the load tool will communicate with it remotely.

1. `--input`, `-i`: A csv input file with individual invocation details for functions. This function **must** be in sorted order on invocatin time
   1. `function_id`: A unique u64 number that maps to the `function_id` in the `metadata` file
   1. `invoke_time_ms`: The time in milliseconds that the function should be invoked at. This is a 0-based time, so if no function is invoked until some time `X`, it will wait.

1. `--metadata`, `-m`: A csv file with function metadata that is associated with the trace file passed in.
It expects the file to have the following columns: `func_name,cold_dur_ms,warm_dur_ms,mem_mb,function_id` .
   1. `func_name`: A string function name, must be unique
   1. `cold_dur_ms`: The cold execution duration in milliseconds
   1. `warm_dur_ms`: The warm execution duration in milliseconds
   1. `mem_mb`: The memory usage in megabytes 
   1. `function_id`: A unique u64 number that maps to the `function_id` in the `input` file

1. `--load-type`, `-l`: This load generator can support two different types of functions to run.
This parameter is only relevant when running against a `live` system.
   1. Synthetic load inside each container started by workers can be achieved via [Lookbusy](http://www.devin.com/lookbusy/).
   The function's runtime characteristics (cold/warm execution time and memory usage) are controlled by lookbusy.
   The values fed to it are taken from the trace metadata to simulate variable functions running inside the system.
   This load method can be specified by passing `lookbusy`, and is the default.

   1. Real code can be run on the functions using modified [FunctionBench](https://github.com/ddps-lab/serverless-faas-workbench) applications.
   The modified programs can be found [nearby](src/load/functions/python3/functions.
   If using real functions, you **must** pass `--function-data` in order for the load tool to find the function with the closest runtime characteristics to each function in the trace.
   It will then run that code when the function is invoked.
   This load method can be specified by passing `functions`.

1. `--function-data`: If using the `functions` option for `--load-type`, a valid json file must be passed here.
This must have runtime data for a list of functions that will be run as placeholders for the functions in the actual trace.
This file can be generated by another command of this tool, the[benchmark](#benchmark-load).
This parameter is only relevant when running against a `live` system.

1. `--worker-config`: A worker config json file, more details on its composition can be found [here](./CONFIG.md#worker-configuration).
Each worker will have an identical configuration.
This value is only relevant, but required, if running a simulated controller or worker.

1. `--controller-config`: A controller config json file, more details on its composition can be found [here](./CONFIG.md#controller-configuration).
This value is only relevant, but required, if running a simulated controller

1. `--workers`, `-w`: The number of simulated workers to create.
This value is only relevant if running a simulated controller

An example load call to a live system:
```sh
ilúvatar_load_gen -p 100 -h localhost trace --target "worker" --setup "live" --input "/my/trace/input.csv" --metadata "/my/trace/metadata-input.csv" --load-type "functions" --function-data "/my/function/data.json
```

An example load call for a simulation:
```sh
ilúvatar_load_gen -p 100 -h localhost trace --target "controller" --setup "simulation" --input "/my/trace/input.csv" --metadata "/my/trace/metadata-input.csv" --worker-config "/my/worker/config.json" --controller-config "/my/controller/config.json" --workers 3
```

### Benchmark load

--functions-dir `src/load/functions/python3/functions`

// TODO: this
